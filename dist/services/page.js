"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _extend=require("./../npm/extend/index.js"),_extend2=_interopRequireDefault(_extend),_util=require("./util.js"),_util2=_interopRequireDefault(_util),_defer=require("./defer.js"),_defer2=_interopRequireDefault(_defer),_request=require("./request.js"),_request2=_interopRequireDefault(_request),_Page=function(t){var e={url:"",limit:10,offset:0};(0,_extend2.default)(!0,e,t||{}),this._defaultConfig=(0,_extend2.default)({},e),this._config=(0,_extend2.default)({},e),this._data=[],this._totalRecord=!1,this._hasFirstRquest=!1};_Page.prototype.init=function(){return this.reset()},_Page.prototype.nullDeferred=function(){var t=(0,_defer2.default)();return setTimeout(function(){t.reject()}),t.promise},_Page.prototype.reset=function(t){return this.requesting?this.nullDeferred():(this._config=(0,_extend2.default)({},this._defaultConfig),this._config=(0,_extend2.default)(this._config,t||{}),this._data=[],this._totalRecord=!1,this._nextKey=null,this.update())},_Page.prototype.update=function(){if(this.requesting)return this.nullDeferred();var t=this,e=(0,_defer2.default)();return this.requesting=!0,t._nextKey&&(this._config.nextKey=t._nextKey),_request2.default.get(t._config.url,t._config).then(function(i){t._hasFirstRquest=!0,i.result&&i.result.nextKey&&(t._nextKey=i.result.nextKey),i.result||(i.result={content:[],totalRecord:0}),t._totalRecord=!i.result.list&&(i.result.totalRecord||0),t._data=t._data.concat(i.result.list||i.result.content||[]),setTimeout(function(){t.requesting=!1},300),t.currentData=i,e.resolve(t._data)},function(i){t._hasFirstRquest=!0,setTimeout(function(){t.requesting=!1},300),t._totalRecord=0,e.reject(i)}),e.promise},_Page.prototype.getCurrentData=function(){return this.currentData},_Page.prototype.duplicateDetection=function(){var t=this._data,e=[],i=[];_util2.default.each(t,function(t,r){t.id||t.msgId?t.id&&-1===i.indexOf(t.id)?(e.push(t),i.push(t.id)):t.msgId&&-1===i.indexOf(t.msgId)&&(e.push(t),i.push(t.msgId)):e.push(t)}),this._data=e},_Page.prototype.next=function(t){var e=this;return this.requesting?this.nullDeferred():this.hasNext()?(e._hasFirstRquest&&(this._config.offset+=this._config.limit),e._config=(0,_extend2.default)(this._config,t||{}),this.update()):null},_Page.prototype.isLast=function(){return"NONE"===this._nextKey||!1!==this._totalRecord&&this._totalRecord<=this._data.length},_Page.prototype.hasNext=function(){return!this.requesting&&("NONE"!==this._nextKey&&(!1===this._totalRecord||!(this._totalRecord<=this._data.length)))},exports.default={Page:function(t){return new _Page(t)}};