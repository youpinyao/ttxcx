"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_request=require("./../services/request.js"),_request2=_interopRequireDefault(_request),_loading=require("./../services/loading.js"),_loading2=_interopRequireDefault(_loading),_urls=require("./../services/urls.js"),_urls2=_interopRequireDefault(_urls),_pay=require("./../services/pay.js"),_pay2=_interopRequireDefault(_pay),_defer=require("./../services/defer.js"),_defer2=_interopRequireDefault(_defer),_wepyComToast=require("./../npm/wepy-com-toast/toast.js"),_wepyComToast2=_interopRequireDefault(_wepyComToast),BookingDetail=function(e){function t(){var e,i,a,n;_classCallCheck(this,t);for(var o=arguments.length,r=Array(o),s=0;s<o;s++)r[s]=arguments[s];return i=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),a.config={navigationBarTitleText:""},a.components={toast:_wepyComToast2.default},a.data={id:"",type:"",selectedPayWay:null,selectedPayWayIndex:null,detail:null,isHidePayTip:!0,isHideRefundTip:!0,isLoaded:!1},a.computed={},a.methods={hidePayTip:function(){a.isHidePayTip=!0},hideRefundTip:function(){a.isHideRefundTip=!0},setPayWay:function(e){a.selectedPayWayIndex=parseInt(e.detail.value,10),a.selectedPayWay=a.detail.payWays[a.selectedPayWayIndex],"OFFLINE"===a.selectedPayWay.type&&(a.isHidePayTip=!1)},doSubmit:function(){_request2.default.post(_urls2.default.bookingPay,{bookingId:a.id,payWay:a.selectedPayWay.type}).then(function(e){if("ONLINE"!==a.selectedPayWay.type){var t=(0,_defer2.default)();return setTimeout(function(){t.resolve()},50),t.promise}return _pay2.default.doPay(e.result)}).then(function(e){_wepy2.default.redirectTo({url:"/pages/booking-pay-success?id="+a.id})},function(e){a.$invoke("toast","show",{title:JSON.stringify(e)})})},doRefund:function(){_request2.default.post(_urls2.default.bookingRefund,{bookingId:a.id}).then(function(e){_wepy2.default.redirectTo({url:"/pages/booking-refund-success?id="+a.id})})},showRefund:function(){a.isHideRefundTip=!1},loadData:function(){_loading2.default.show(),_request2.default.get(_urls2.default.bookingDetail,{bookingId:a.id}).then(function(e){a.detail=e.result,a.detail.payWays.forEach(function(e,t){a.detail.selectedPayWay&&e.type===a.detail.selectedPayWay.type&&(a.selectedPayWayIndex=t)}),null===a.selectedPayWayIndex&&(a.selectedPayWayIndex=0),a.selectedPayWay=a.detail.payWays[a.selectedPayWayIndex],a.$apply()}).finally(function(){_loading2.default.hide()})}},a.events={},n=i,_possibleConstructorReturn(a,n)}return _inherits(t,e),_createClass(t,[{key:"onShow",value:function(){this.methods.loadData()}},{key:"onLoad",value:function(e){console.log("booking detail on load"),this.isLoaded=!0,_wepy2.default.setNavigationBarTitle({title:"settle"===e.type?"确定订单":"预约记录"}),this.type=e.type,this.id=e.id}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(BookingDetail,"pages/booking-detail"));