"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _getPrototypeOf=require("./../npm/babel-runtime/core-js/object/get-prototype-of.js"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("./../npm/babel-runtime/helpers/classCallCheck.js"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("./../npm/babel-runtime/helpers/createClass.js"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("./../npm/babel-runtime/helpers/possibleConstructorReturn.js"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("./../npm/babel-runtime/helpers/inherits.js"),_inherits3=_interopRequireDefault(_inherits2),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_is=require("./../services/is.js"),_is2=_interopRequireDefault(_is),_util=require("./../services/util.js"),_util2=_interopRequireDefault(_util),_dots=require("./../services/dots.js"),_dots2=_interopRequireDefault(_dots),_urls=require("./../services/urls.js"),_urls2=_interopRequireDefault(_urls),_request=require("./../services/request.js"),_request2=_interopRequireDefault(_request),_loading=require("./../services/loading.js"),_loading2=_interopRequireDefault(_loading),_question=require("./../services/question.js"),_question2=_interopRequireDefault(_question),Booking=function(e){function t(){var e,n,r,o;(0,_classCallCheck3.default)(this,t);for(var a=arguments.length,s=Array(a),i=0;i<a;i++)s[i]=arguments[i];return n=r=(0,_possibleConstructorReturn3.default)(this,(e=t.__proto__||(0,_getPrototypeOf2.default)(t)).call.apply(e,[this].concat(s))),r.config={navigationBarTitleText:""},r.canvasIdErrorCallback=function(e){console.error("canvas error",e.detail.errMsg)},r.components={},r.data={expand:!1,userInfo:null,systemInfo:null,id:null,scrollTop:0,dots:null,screenScale:1,canvasWidth:null,canvasHeight:null,challengeData:null,timer:null,hasPoint:!1,pointPosition:null,drawDots:[],drawLines:[]},r.computed={},r.methods={doExpand:function(e){r.expand="true"===e},hasUpdateCanvas:function(e){if(_is2.default.empty(e))return!1;if(_is2.default.empty(r.challengeData))return!0;var t=0;return _util2.default.each(r.challengeData,function(n,r){n!==e[r]&&-1!==["checkpointCount","checkpointCurrent","status","isEnd"].indexOf(r)&&t++}),t>0},updateChallege:function(){console.log("check update challege"),_request2.default.get(_urls2.default.challengeData).then(function(e){var t=e.result;clearTimeout(r.timer),r.timer=setTimeout(function(){r.methods.updateChallege()},6e3);var n=r.methods.hasUpdateCanvas(t);t.scoreFormat=_util2.default.renderScore(t.score),r.challengeData=t,n&&(console.log("update challege canvas"),r.methods.drawDot(),_question2.default.check(),setTimeout(function(){r.scrollTop=r.scrollTop+1,r.$apply()}),_wepy2.default.setNavigationBarTitle({title:r.challengeData.isEnd?"战绩详情":"塔拓时刻"})),r.$apply(),_loading2.default.hide()})},updatePoint:function(e){var t=0===r.challengeData.status;r.hasPoint=t,r.pointPosition={x:e.x/2-25/r.screenScale,y:e.y/2-25/r.screenScale}},drawDot:function(){var e=r.screenScale,t=140/e,n=r.challengeData,o=r.dots.map(function(e){return{x:e.x,y:e.y}});if(n.checkpointCount>o.length-1)for(var a=n.checkpointCount-o.length+1,s=o.length-2,i=0;i<a;i++)!function(e){var n=e<=s?e:e%s,r=o[n];o=o.map(function(e){return e.y+=200,e}),o.push({x:r.x,y:t})}(i);else n.checkpointCount<o.length-1&&o.splice(n.checkpointCount+1,o.length-n.checkpointCount);if(o[0].y/2-o[o.length-1].y/2+t<r.systemInfo.windowHeight){var l=o[0].y-2*r.systemInfo.windowHeight;o=o.map(function(e){return e.y-=l,e})}r.canvasHeight=o[0].y/2,r.canvasWidth=r.systemInfo.windowWidth;var u=[];o.forEach(function(e,t){var n=o[t+1];if(n){var r=Math.abs(n.x/2-e.x/2),a=Math.abs(n.y/2-e.y/2),s=Math.pow(Math.pow(r,2)+Math.pow(a,2),.5),i=180*Math.asin(a/s)/Math.PI;n.x>=e.x&&n.y<=e.y?i=-i:n.x>=e.x&&n.y>e.y||(n.x<e.x&&n.y<=e.y?i-=180:n.x<e.x&&n.y>e.y&&(i=-i-180)),u.push({x:e.x/2,y:e.y/2,width:s,rotate:i,color:"#8c8c8d"})}}),r.drawLines=u;var c=[];o.forEach(function(e,t){var o={};0!==t&&(n.checkpointCurrent>t?o={size:12,x:e.x/2-6,y:e.y/2-6,color:"#df540e",fontColor:"#df540e"}:n.checkpointCurrent===t?(o=2===n.status?{size:24,x:e.x/2-12,y:e.y/2-12,color:"#333333",fontColor:"#333333",fail:!0}:{size:12,x:e.x/2-6,y:e.y/2-6,color:"#df540e",fontColor:0===n.status?"#ffcd55":"#df540e",ing:0===n.status},r.methods.updatePoint(e),r.scrollTop=parseInt(e.y/2-r.systemInfo.windowHeight+100,10)):o={size:12,x:e.x/2-6,y:e.y/2-6,color:"#ffffff",fontColor:"#ffffff"},o.text=1===t?"1st":1===t?"2nd":1===t?"3rd":t+"th",c.push(o))}),r.drawDots=c}},r.events={},o=n,(0,_possibleConstructorReturn3.default)(r,o)}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"onShow",value:function(){this.isReady&&(clearTimeout(this.timer),this.methods.updateChallege())}},{key:"onHide",value:function(){clearTimeout(this.timer)}},{key:"onLoad",value:function(e){console.log("challenge on load",e),this.id=e.id,_loading2.default.show()}},{key:"onReady",value:function(){var e=this,t=this,n=_wepy2.default.getSystemInfoSync(),r=375/n.windowWidth;this.isReady=!0,this.systemInfo=n,this.context=_wepy2.default.createCanvasContext("dotsCanvas"),this.screenScale=r,this.dots=_dots2.default.map(function(e){return{x:e.x/r,y:e.y/r}}),_request2.default.getUserInfo().then(function(n){t.userInfo=n,clearTimeout(e.timer),e.methods.updateChallege()})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Booking,"pages/challenge"));