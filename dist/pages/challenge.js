"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_is=require("./../services/is.js"),_is2=_interopRequireDefault(_is),_util=require("./../services/util.js"),_util2=_interopRequireDefault(_util),_dots=require("./../services/dots.js"),_dots2=_interopRequireDefault(_dots),_urls=require("./../services/urls.js"),_urls2=_interopRequireDefault(_urls),_request=require("./../services/request.js"),_request2=_interopRequireDefault(_request),_loading=require("./../services/loading.js"),_loading2=_interopRequireDefault(_loading),_question=require("./../services/question.js"),_question2=_interopRequireDefault(_question),Booking=function(e){function t(){var e,n,o,r;_classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return n=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),o.config={navigationBarTitleText:""},o.canvasIdErrorCallback=function(e){console.error("canvas error",e.detail.errMsg)},o.components={},o.data={expand:!1,userInfo:null,systemInfo:null,id:null,scrollTop:0,dots:null,screenScale:1,canvasWidth:null,canvasHeight:null,challengeData:null,timer:null,hasPoint:!1,pointPosition:null,drawDots:[],drawLines:[]},o.computed={},o.methods={toPictures:function(){_wepy2.default.navigateTo({url:"/pages/pictures?id="+o.id})},doExpand:function(e){o.expand="true"===e},hasUpdateCanvas:function(e){if(_is2.default.empty(e))return!1;if(_is2.default.empty(o.challengeData))return!0;if(e&&e.beforePoints&&o.challengeData&&o.challengeData.beforePoints&&o.challengeData.beforePoints.join(",")!==e.beforePoints.join(","))return!0;var t=0;return _util2.default.each(o.challengeData,function(n,o){n!==e[o]&&-1!==["checkpointCount","checkpointCurrent","status","isEnd"].indexOf(o)&&t++}),t>0},updateChallege:function(){console.log("check update challege"),_request2.default.get(_urls2.default.challengeData,{challengeId:o.id}).then(function(e){var t=e.result;clearTimeout(o.timer),o.timer=setTimeout(function(){o.methods.updateChallege()},6e3);var n=o.methods.hasUpdateCanvas(t);t.scoreFormat=_util2.default.renderScore(t.score),o.challengeData=t,n&&(console.log("update challege canvas"),o.methods.drawDot(),_question2.default.check(),setTimeout(function(){o.scrollTop=o.scrollTop+1,o.$apply()}),_wepy2.default.setNavigationBarTitle({title:o.challengeData.isEnd?"战绩详情":"塔拓时刻"})),o.$apply(),_loading2.default.hide()})},updatePoint:function(e){var t=0===o.challengeData.status;o.hasPoint=t,o.pointPosition={x:e.x/2-25/o.screenScale,y:e.y/2-25/o.screenScale}},drawDot:function(){var e=o.screenScale,t=140/e,n=o.challengeData,r=o.dots.map(function(e){return{x:e.x,y:e.y}}),a="#df540e",i="#333333";if(n.checkpointCount>r.length-1)for(var s=n.checkpointCount-r.length+1,l=r.length-2,u=0;u<s;u++)!function(e){var n=e<=l?e:e%l,o=r[n];r=r.map(function(e){return e.y+=200,e}),r.push({x:o.x,y:t})}(u);else n.checkpointCount<r.length-1&&r.splice(n.checkpointCount+1,r.length-n.checkpointCount);if(r[0].y/2-r[r.length-1].y/2+t<o.systemInfo.windowHeight){var c=r[0].y-2*o.systemInfo.windowHeight;r=r.map(function(e){return e.y-=c,e})}o.canvasHeight=r[0].y/2,o.canvasWidth=o.systemInfo.windowWidth;var f=[];r.forEach(function(e,t){var n=r[t+1];if(n){var o=Math.abs(n.x/2-e.x/2),a=Math.abs(n.y/2-e.y/2),i=Math.pow(Math.pow(o,2)+Math.pow(a,2),.5),s=180*Math.asin(a/i)/Math.PI;n.x>=e.x&&n.y<=e.y?s=-s:n.x>=e.x&&n.y>e.y||(n.x<e.x&&n.y<=e.y?s-=180:n.x<e.x&&n.y>e.y&&(s=-s-180)),f.push({x:e.x/2,y:e.y/2,width:i,rotate:s,color:"#8c8c8d"})}}),o.drawLines=f;var p=[];r.forEach(function(e,t){var r={};0!==t&&(n.checkpointCurrent>t?r={size:12,x:e.x/2-6,y:e.y/2-6,color:n.beforePoints?["#ffffff",a,i][n.beforePoints[t]]:a,fontColor:n.beforePoints?["#ffffff",a,i][n.beforePoints[t]]:a}:n.checkpointCurrent===t?(r=2===n.status?{size:24,x:e.x/2-12,y:e.y/2-12,color:i,fontColor:i,fail:!0}:{size:12,x:e.x/2-6,y:e.y/2-6,color:a,fontColor:0===n.status?"#ffcd55":a,ing:0===n.status},o.methods.updatePoint(e),o.scrollTop=parseInt(e.y/2-o.systemInfo.windowHeight+100,10)):r={size:12,x:e.x/2-6,y:e.y/2-6,color:"#ffffff",fontColor:"#ffffff"},r.text=1===t?"1st":1===t?"2nd":1===t?"3rd":t+"th",p.push(r))}),o.drawDots=p}},o.events={},r=n,_possibleConstructorReturn(o,r)}return _inherits(t,e),_createClass(t,[{key:"onHide",value:function(){clearTimeout(this.timer)}},{key:"onLoad",value:function(e){console.log("challenge on load",e),this.id=e.id,_loading2.default.show()}},{key:"onShow",value:function(){var e=this,t=this,n=_wepy2.default.getSystemInfoSync(),o=375/n.windowWidth;this.systemInfo=n,this.screenScale=o,this.dots=_dots2.default.map(function(e){return{x:e.x/o,y:e.y/o}}),_request2.default.getUserInfo().then(function(n){t.userInfo=n,clearTimeout(e.timer),e.methods.updateChallege()})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Booking,"pages/challenge"));